<div
  class="offcanvas offcanvas-end"
  tabindex="-1"
  id="offcanvasRight"
  aria-labelledby="offcanvasRightLabel"
  style="width: 480px"
>
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasRightLabel">Your Cart</h5>
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="offcanvas"
      aria-label="Close"
    ></button>
  </div>

  <div class="offcanvas-body">
    <div id="cartContent">
      <table class="table table-striped align-middle text-center">
        <thead class="table-light">
          <tr>
            <th scope="col">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-bag-heart"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0M14 14V5H2v9a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1M8 7.993c1.664-1.711 5.825 1.283 0 5.132-5.825-3.85-1.664-6.843 0-5.132"
                />
              </svg>
            </th>
            <th scope="col">Unit Price</th>
            <th scope="col">Quantity</th>
            <th scope="col">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-trash"
                viewBox="0 0 16 16"
              >
                <path
                  d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"
                />
                <path
                  d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"
                />
              </svg>
            </th>
          </tr>
        </thead>
        <tbody id="cartTable"></tbody>
      </table>

      <!-- Checkout button -->
      <div class="d-flex justify-content-center mt-3">
        <button
          class="btn w-100"
          id="checkoutBtn"
          style="background-color: #0d464c; color: white"
        >
          Proceed to Checkout
        </button>
      </div>
    </div>

    <!-- Empty cart message -->
    <div
      id="emptyCart"
      class="d-flex flex-column justify-content-center align-items-center"
      style="height: 100%"
    >
      <p class="fw-semibold mb-3 fs-5">Your cart is empty</p>
      <button class="btn" style="background-color: #0d464c; color: white">
        Continue Shopping
      </button>
    </div>
  </div>
</div>
<script>
  (function(){
    const CART_KEY = 'cart';
    function readCart(){
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch(e){ return []; }
    }
    function writeCart(list){
      localStorage.setItem(CART_KEY, JSON.stringify(list));
      updateBadge();
      updateEmptyState();
    }
    function updateBadge(){
      try {
        const numEl = document.querySelector('.num');
        const items = readCart();
        const total = items.reduce((s,i)=> s + (Number(i.qty)||0), 0);
        if (numEl) numEl.textContent = String(total);
      } catch(_){}
    }
    function updateEmptyState(){
      const items = readCart();
      const has = items.length > 0;
      const content = document.getElementById('cartContent');
      const empty = document.getElementById('emptyCart');
      if (content) content.style.display = has ? 'block' : 'none';
      if (empty) empty.style.display = has ? 'none' : 'flex';
    }
    function renderCart(){
      const tbody = document.getElementById('cartTable');
      if (!tbody) return;
      tbody.innerHTML = '';
      const items = readCart();
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', item.id);
        const price = Number(item.price)||0;
        const qty = Number(item.qty)||1;
        const name = (item.name||'Product').replace(/\"/g,'&quot;');
        tr.innerHTML = `
          <td>
            <div class="ratio ratio-1x1" style="width: 60px">
              <img src="${item.image||''}" class="img-fluid rounded" alt="${name}" />
            </div>
          </td>
          <td class="price" data-price="${price}">$${price.toFixed(2)}</td>
          <td>
            <div style="display:inline-flex;align-items:center;background:#e0e5ec9f;box-shadow:inset 2px 2px 4px rgba(163,177,198,0.6), inset -2px -2px 4px rgba(255,255,255,0.9);color:#0d464c;box-shadow:2px 1px 8px #000000a2;border-radius:6px;overflow:hidden;box-sizing:border-box;height:32px;">
              <button type="button" class="qty-dec" aria-label="decrease" style="width:32px;height:100%;padding:0;margin:0;border:none;background:transparent;display:inline-flex;align-items:center;justify-content:center;font-size:16px;line-height:1;color:#0d464c;cursor:pointer;">âˆ’</button>
              <span class="count" style="display:inline-flex;align-items:center;justify-content:center;padding:0 10px;min-width:26px;font-weight:700;font-size:18px;">${qty}</span>
              <button type="button" class="qty-inc" aria-label="increase" style="width:32px;height:100%;padding:0;margin:0;border:none;background:transparent;display:inline-flex;align-items:center;justify-content:center;font-size:16px;line-height:1;color:#0d464c;cursor:pointer;">+</button>
            </div>
          </td>
          <td><button type="button" class="btn-close deleteRow" aria-label="Close"></button></td>
        `;
        tbody.appendChild(tr);
      });
      updateBadge();
      updateEmptyState();
    }
    function addItem({id,name,price,image,qty}){
      if (!id) return;
      const cart = readCart();
      const idx = cart.findIndex(i=> i.id === id);
      const inc = Number(qty)||1;
      if (idx >= 0) {
        cart[idx].qty = Number(cart[idx].qty||0) + inc;
      } else {
        cart.push({ id, name: name||'Product', price: Number(price)||0, image: image||'', qty: inc });
      }
      writeCart(cart);
      renderCart();
    }
    function updateQty(id, newQty){
      const cart = readCart();
      const i = cart.findIndex(x=> x.id === id);
      if (i < 0) return;
      const q = Math.max(1, Number(newQty)||1);
      cart[i].qty = q;
      writeCart(cart);
      renderCart();
    }
    function removeItem(id){
      let cart = readCart();
      cart = cart.filter(x=> x.id !== id);
      writeCart(cart);
      renderCart();
    }
    function parsePriceFromText(txt){
      if (!txt) return 0;
      const m = String(txt).replace(/,/g,'').match(/([0-9]+(?:\.[0-9]+)?)/);
      return m ? Number(m[1]) : 0;
    }
    function getProductInfoFromElement(btn){
      const d = btn.dataset || {};
      let id = d.id || btn.getAttribute('data-id');
      let name = d.name || '';
      let price = d.price;
      let image = d.image || '';
      let qty = Number(d.qty) || 1;
      if (!id) {
        const card = btn.closest('.product');
        id = card?.getAttribute('data-product-id') || (card?.querySelector('h3')?.textContent||'').trim();
      }
      if (!name) {
        name = (btn.closest('.product')?.querySelector('h3')?.textContent || '').trim();
      }
      if (price == null) {
        const card = btn.closest('.product');
        const moneyTxt = card?.querySelector('.name_price span')?.textContent || '';
        price = parsePriceFromText(moneyTxt);
      } else {
        price = Number(price);
      }
      if (!image) {
        const card = btn.closest('.product');
        image = card?.querySelector('.image img')?.getAttribute('src') || '';
      }
      return { id, name, price, image, qty };
    }

    // Add to cart (delegated for static/dynamic buttons)
    document.addEventListener('click', function(e){
      const btn = e.target.closest && e.target.closest('.add-btn');
      if (!btn) return;
      e.preventDefault();
      const info = getProductInfoFromElement(btn);
      addItem({ ...info, qty: info.qty || 1 });
      try {
        const offcanvasEl = document.getElementById('offcanvasRight');
        if (offcanvasEl) bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl).show();
      } catch(_){}
    });

    // Cart table controls (delegated)
    const table = document.getElementById('cartTable');
    if (table) {
      table.addEventListener('click', function(e){
        const dec = e.target.closest && e.target.closest('.qty-dec');
        const inc = e.target.closest && e.target.closest('.qty-inc');
        const del = e.target.closest && e.target.closest('.deleteRow');
        const row = e.target.closest('tr');
        const id = row ? row.getAttribute('data-id') : null;
        if (!row || !id) return;
        if (dec) {
          const countEl = row.querySelector('.count');
          const cur = parseInt(countEl?.textContent||'1', 10);
          updateQty(id, Math.max(1, cur - 1));
        } else if (inc) {
          const countEl = row.querySelector('.count');
          const cur = parseInt(countEl?.textContent||'1', 10);
          updateQty(id, cur + 1);
        } else if (del) {
          removeItem(id);
        }
      });
    }

    // Checkout button action
    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) checkoutBtn.addEventListener('click', function(){
      const items = readCart();
      if (!items.length) { alert('Your cart is empty.'); return; }
      window.location.href = '/checkout';
    });

    // Continue shopping hides offcanvas
    const contBtn = document.querySelector('#emptyCart .btn');
    if (contBtn) contBtn.addEventListener('click', function(){
      try {
        const offcanvasEl = document.getElementById('offcanvasRight');
        if (offcanvasEl) bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl).hide();
      } catch(_){}
    });

    document.addEventListener('DOMContentLoaded', function(){ renderCart(); });
    window.addEventListener('storage', function(e){ if (e.key === CART_KEY) renderCart(); });
    try { document.getElementById('offcanvasRight')?.addEventListener('shown.bs.offcanvas', renderCart); } catch(_){}
    // initial state
    updateBadge();
    updateEmptyState();
  })();
</script>
