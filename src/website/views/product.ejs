<!DOCTYPE html>
<html lang="en">
  <%- include('./includes/head') %>
  <body>
    <%- include('./includes/navbar')%>

    <!-- Breadcrumb -->
    <div class="container mt-3">
      <nav aria-label="breadcrumb">
        <% 
          const catObj = (product.category && typeof product.category === 'object') ? product.category : null;
          const categoryName = catObj ? (catObj.name || catObj.title || String(catObj)) : (product.category || '');
          const rawSlug = catObj ? (catObj.slug || catObj.id || categoryName) : categoryName;
          const categorySlug = String((rawSlug||'')).toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
        %>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/" data-i18n="home">Home</a></li>
          <% if (categoryName) { %>
          <li class="breadcrumb-item"><a href="/category/<%= encodeURIComponent(categorySlug) %>"><%= categoryName %></a></li>
          <% } %>
          <li class="breadcrumb-item active" aria-current="page"><%= product.name %></li>
        </ol>
      </nav>
    </div>
    
    <!-- Product Section -->
    <div class="container my-4 product-detail">
      <div class="row g-5 align-items-start pd-wrapper">
        <!-- Product Image -->
        <div class="col-lg-6 product-gallery">
          <div class="mb-3 position-relative gallery-card glass">
            <% function resolveImg(u){ try{ u=String(u||''); }catch(_){ u=''; } if(/^https?:\/\//i.test(u)) return u; if(u.startsWith('/images')||u.startsWith('images/')) return u.startsWith('/')?u:'/'+u; if(!u) return '/images/cover_phone.jpg'; if(u.startsWith('/')) return 'http://localhost:8000'+u; return 'http://localhost:8000/'+u; } %>
            <img
              id="mainProductImage"
              src="<%= resolveImg(product.image) %>"
              class="img-fluid rounded w-100 main-photo"
              alt="<%= product.name %>"
            />
            <% if ((product.images||[]).length > 1) { %>
            <div class="d-flex align-items-center mt-3 thumbs-bar">
              <button id="thumbLeft" class="btn btn-light me-2" type="button">
                <i class="fas fa-chevron-left"></i>
              </button>
              <div id="thumbScroll" class="d-flex overflow-auto" style="gap: 16px; width: 100%; max-width: 100%; scroll-behavior: smooth; direction: rtl; padding-bottom: 8px;">
                <% (product.images||[]).forEach(function(img, idx){ %>
                <img
                  src="<%= resolveImg(img) %>"
                  class="img-thumbnail thumb-img"
                  alt="Thumb <%= idx+1 %>"
                />
                <% }) %>
              </div>
              <button id="thumbRight" class="btn btn-light ms-2" type="button">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            <% } %>
          </div>
        </div>

        <!-- Product Details -->
        <div class="col-lg-6 product-info-card glass">
          <h1 class="product-title"><%= product.name %></h1>
          <% if (product.category) { %>
            <div class="category-name"><%= product.category.name || product.category %></div>
          <% } %>
          <div class="price">
            <span class="sale-price">$<%= Number(product.price||0).toFixed(2) %></span>
          </div>

          <p class="mb-4"><%= product.description || '' %></p>

          <% if (product.attributes && Object.keys(product.attributes).length) { %>
          <div class="mb-3 attribute">
            <div style="margin-bottom: 8px">Attributes:</div>
              <% Object.keys(product.attributes).forEach(function(key){ %>
              <div class="mt-2"><strong><%= key %>:</strong> <span class="att-values">
                <% if (Array.isArray(product.attributes[key])) { product.attributes[key].forEach(function(v){ %>
                  <span class="chip"><%= v %></span>
                <% }) } else { %>
                  <span class="chip"><%= product.attributes[key] %></span>
                <% } %>
              </span></div>
            <% }) %>
          </div>
          <% } %>

          <!-- count -->
          <div class="d-flex align-items-center mb-4">
            <div class="quantity-selector">
              <span class="quantity-btn" id="qtyDec">-</span>
              <input type="text" class="quantity-input" id="qtyInput" value="1" />
              <span class="quantity-btn" id="qtyInc">+</span>
            </div>
          </div>
          <!-- button -->
          <div class="d-flex mb-4 buttons">
            <button class="btn btn-share-now" id="shareBtn" data-i18n="shareNow">Share now</button>
            <button class="btn btn-add-to-cart add-btn"
                    data-id="<%= product.id %>"
                    data-name="<%= product.name %>"
                    data-price="<%= product.price %>"
                    data-image="<%= product.image %>" data-i18n="addToCart">Add To Cart</button>
            <button class="btn btn-buy-now" id="buyNowBtn" data-i18n="buyNow">Buy Now</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Description Tabs -->
    <div class="container my-5">
      <ul class="nav nav-tabs" id="productTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">Description</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="information-tab" data-bs-toggle="tab" data-bs-target="#information" type="button" role="tab">Additional Information</button>
        </li>
      </ul>

      <div class="tab-content" id="productTabsContent">
        <div class="tab-pane fade show active" id="description" role="tabpanel">
          <div class="section-card">
            <h5 class="section-title"><i class="fa-solid fa-align-left"></i> <span data-i18n="description">Description</span></h5>
            <div class="section-body prose"><%= product.description || 'No description available.' %></div>
          </div>
        </div>

        <div class="tab-pane fade" id="information" role="tabpanel">
          <div class="section-card">
            <h5 class="section-title"><i class="fa-solid fa-circle-info"></i> <span data-i18n="additionalDetails">Additional Details</span></h5>
            <div class="details-grid">
              <div class="detail-item">
                <span class="detail-label" data-i18n="code">Code</span>
                <span class="detail-value"><%= product.id %></span>
              </div>
              <div class="detail-item">
                <span class="detail-label" data-i18n="category">Category</span>
                <span class="detail-value"><%= product.category && (product.category.name || product.category) || '-' %></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('./includes/cart') %>

    <script>
      (function(){
        // thumbs -> main image swap
        document.addEventListener('click', function(e){
          const t = e.target;
          if (t && t.classList && t.classList.contains('thumb-img')){
            const main = document.getElementById('mainProductImage');
            if (main) main.src = t.getAttribute('src');
          }
        });
        // qty controls
        const qtyInput = document.getElementById('qtyInput');
        const dec = document.getElementById('qtyDec');
        const inc = document.getElementById('qtyInc');
        const clamp = (v)=> Math.max(1, parseInt((v==null? '1' : String(v)),10) || 1);
        if (dec) dec.addEventListener('click', ()=>{
          const curr = clamp(qtyInput && qtyInput.value);
          qtyInput.value = clamp(curr - 1);
        });
        if (inc) inc.addEventListener('click', ()=>{
          const curr = clamp(qtyInput && qtyInput.value);
          qtyInput.value = clamp(curr + 1);
        });
        if (qtyInput) qtyInput.addEventListener('input', ()=>{
          const digits = String(qtyInput.value||'').replace(/\D/g,'');
          qtyInput.value = digits ? clamp(digits) : 1;
        });
        // Add to cart with selected qty
        document.addEventListener('click', function(e){
          const btn = e.target.closest && e.target.closest('.add-btn');
          if (!btn) return;
          const q = clamp(qtyInput?.value || 1);
          btn.dataset && (btn.dataset.qty = String(q));
        });
        // Share
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn && navigator.share){
          shareBtn.addEventListener('click', function(){
            navigator.share({ title: '<%= product.name %>', text: '<%= (product.description||'').replace(/"/g,'\"') %>', url: window.location.href }).catch(()=>{});
          });
        }
        const buyNowBtn = document.getElementById('buyNowBtn');
        if (buyNowBtn) buyNowBtn.addEventListener('click', function(){
          // ensure one item in cart, then go checkout
          try {
            const CART_KEY = 'cart';
            const items = JSON.parse(localStorage.getItem(CART_KEY)||'[]');
            const id = '<%= product.id %>';
            const idx = items.findIndex(i=> String(i.id)===String(id));
            const qty = clamp(qtyInput?.value || 1);
            if (idx>=0) items[idx].qty = qty; else items.push({ id, name: '<%= product.name %>', price: Number(<%= JSON.stringify(product.price) %>), image: '<%= product.image %>', qty });
            localStorage.setItem(CART_KEY, JSON.stringify(items));
          } catch(_){}
          window.location.href = '/checkout';
        });
      })();
    </script>

    <style>
      :root {
        --primary: #0D464C;
        --secondary: #F05928;
        --bg: #f6f8fb;
        --card: rgba(255,255,255,0.78);
        --border: rgba(13,70,76,.12);
        --shadow: 0 16px 40px rgba(13,70,76,.12);
        --shadow-soft: 0 8px 20px rgba(13,70,76,.10);
        --text: #0d1b2a;
        --muted: #6b7785;
      }

      body { background: linear-gradient(to bottom, #ded2c2 0%, #e9e1d6 60%, #f5f2ec 100%); color: var(--text); }

      .product-detail { position: relative; }
      .pd-wrapper {}
      .product-gallery { position: sticky; top: 86px; }
      @media (max-width: 991.98px) { .product-gallery { position: static; } }

      .gallery-card { padding: 14px; border-radius: 18px; background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.78)); backdrop-filter: blur(10px); border: 1px solid var(--border); box-shadow: var(--shadow); }
      .main-photo { border-radius: 14px; box-shadow: var(--shadow-soft); object-fit: cover; transition: transform .25s ease; }
      .main-photo:hover { transform: scale(1.01); }
      .thumbs-bar { gap: 12px; }
      #thumbLeft,#thumbRight { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); background: #fff; box-shadow: var(--shadow-soft); color: var(--primary); }
      #thumbLeft:hover,#thumbRight:hover { transform: translateY(-1px); }
      .thumb-img { width: 86px; height: 86px; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); transition: .2s ease; background:#fff; }
      .thumb-img:hover { transform: translateY(-2px); box-shadow: var(--shadow-soft); }
      .att-values { display: inline-block; margin-left: 8px; }
      .chip { display:inline-block; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid var(--border); color: var(--primary); font-weight:700; margin:4px 6px 0 0; box-shadow: var(--shadow-soft); }

      .product-info-card { background: var(--card); backdrop-filter: blur(10px); border: 1px solid var(--border); box-shadow: var(--shadow); border-radius: 18px; padding: 22px; }
      .product-title { font-weight: 900; letter-spacing: 0.2px; margin-bottom: 6px; color: var(--primary); font-size: clamp(1.8rem, 1.4vw + 1.6rem, 2.6rem); }
      .category-name { color: var(--muted); font-weight: 600; margin-bottom: 12px; }
      .price { margin: 10px 0 18px; }
      .sale-price { font-weight: 900; background: linear-gradient(135deg, var(--secondary), #ff9157); -webkit-background-clip: text; background-clip: text; color: transparent; font-size: clamp(1.6rem, 1.1vw + 1.4rem, 2.2rem); }

      .quantity-selector { display: inline-flex; align-items: center; gap: 10px; background: #ffffff; border: 1px solid var(--border); box-shadow: var(--shadow-soft); height: 44px; padding: 0 10px; border-radius: 999px; }
      .quantity-btn { width: 34px; height: 34px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--border); background: #fff; color: var(--primary); font-weight: 800; cursor: pointer; }
      .quantity-input { width: 54px; height: 34px; border: none; outline: none; text-align: center; font-weight: 700; color: var(--text); background: transparent; }

      /* Scope product action buttons so navbar buttons keep their main-page style */
      .product-detail .buttons { gap: 12px; }
      .product-detail .btn { border-radius: 12px; font-weight: 700; padding: 10px 16px; box-shadow: var(--shadow-soft); border: none; transition: transform .15s ease, box-shadow .15s ease; }
      .product-detail .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
      .product-detail .btn-add-to-cart { background: linear-gradient(135deg, var(--primary), #0a2f34); color: #fff; }
      .product-detail .btn-buy-now { background: linear-gradient(135deg, var(--secondary), #ff9157); color: #fff; }
      .product-detail .btn-share-now { background: #fff; border: 1px solid var(--border); color: var(--primary); }
      .product-detail .btn-add-to-cart i, .product-detail .btn-buy-now i { margin-right:6px; }

      #productTabs { border: 0; display: inline-flex; gap: 8px; }
      .nav-tabs { border: none; margin-bottom: 12px; overflow-x: auto; }
      .nav-tabs .nav-link { border: 0; color: var(--primary); font-weight: 700; border-radius: 999px; padding: 12px 20px; background:#ffffff; border:1px solid var(--border); font-size: 1rem; }
      .nav-tabs .nav-link.active { color: #fff; background: linear-gradient(135deg, var(--primary), #0a2f34); box-shadow: var(--shadow-soft); border: 0; }
      .nav.nav-tabs#productTabs .nav-item { margin-right: 8px; }
      .nav.nav-tabs#productTabs .nav-link { min-height: 48px; min-width: 160px; padding: 12px 24px; font-size: 1.05rem; line-height: 1.25; display: inline-flex; align-items: center; justify-content: center; }
      @media (max-width: 576px) {
        #productTabs { width: 100%; flex-wrap: wrap; gap: 8px; }
        #productTabs .nav-link { flex: 1 1 100%; min-width: 0; }
      }

      .section-card { background: #fff; border: 1px solid var(--border); border-radius: 16px; padding: 18px 20px; box-shadow: var(--shadow-soft); position:relative; }
      .section-card::before { content:''; position:absolute; left:12px; right:12px; top:0; height:4px; border-radius: 0 0 2px 2px; background: linear-gradient(90deg, var(--secondary), #ffb088); }
      .section-title { display:flex; align-items:center; gap:8px; font-weight:900; color: var(--primary); margin: 6px 0 12px; letter-spacing:.2px; }
      .section-body { color: #0f2234; line-height: 1.8; }
      .prose p + p { margin-top: .5rem; }
      .details-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
      @media (max-width: 576px) { .details-grid { grid-template-columns: 1fr; } }
      .detail-item { display:flex; align-items:center; justify-content:space-between; background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; box-shadow: var(--shadow-soft); }
      .detail-label { color: var(--muted); font-weight:800; }
      .detail-value { color: var(--primary); font-weight:900; background:#f6f8fb; border:1px solid #e5e9ef; padding:6px 10px; border-radius:999px; }

      .spec-table { width: 100%; border-collapse: separate; border-spacing: 0; overflow: hidden; border-radius: 12px; box-shadow: var(--shadow-soft); }
      .spec-table td { padding: 12px 14px; background: #fff; border-bottom: 1px solid #eef2f5; }
      .spec-table tr:nth-child(2n) td { background: #fafcfd; }
      .spec-table tr:last-child td { border-bottom: none; }
      .spec-table td:first-child { font-weight: 700; color: var(--primary); width: 30%; }

      @media (max-width: 576px) {
        .thumb-img { width: 64px; height: 64px; }
        .buttons { flex-wrap: wrap; }
      }

      /* Minimal, clean overrides */
      .product-detail { max-width: 1200px; margin: 0 auto; }
      .gallery-card { padding: 12px; border-radius: 14px; background: #fff; border: 1px solid rgba(13,70,76,.08); box-shadow: 0 4px 12px rgba(13,70,76,.06); }
      .main-photo { border-radius: 12px; box-shadow: none; }
      .thumbs-bar { gap: 8px; }
      #thumbLeft,#thumbRight { width: 36px; height: 36px; border: 1px solid rgba(13,70,76,.12); background: #fff; }
      .thumb-img { width: 72px; height: 72px; border-radius: 10px; border: 1px solid rgba(13,70,76,.12); }

      .product-info-card { background: #fff; border: 1px solid rgba(13,70,76,.08); border-radius: 14px; box-shadow: 0 4px 12px rgba(13,70,76,.06); padding: 20px; }
      .product-title { margin-bottom: 6px; }
      .category-name { margin-bottom: 12px; }
      .price { margin: 10px 0 16px; }
      .sale-price { font-size: clamp(1.7rem, 1.1vw + 1.5rem, 2.2rem); color: #f05928; background: none; }

      .quantity-selector { height: 40px; border-radius: 999px; border: 1px solid rgba(13,70,76,.12); background: #fff; }
      .quantity-btn { width: 32px; height: 32px; border: 1px solid rgba(13,70,76,.12); }
      .quantity-input { width: 54px; height: 32px; }

      .product-detail .btn { border-radius: 10px; font-weight: 700; padding: 10px 16px; }
      .product-detail .btn-add-to-cart { background: #0d464c; color: #fff; }
      .product-detail .btn-add-to-cart:hover { filter: brightness(1.05); }
      .product-detail .btn-buy-now { background: #f05928; color: #fff; }
      .product-detail .btn-share-now { background: #fff; border: 1px solid rgba(13,70,76,.12); color:#0d464c; }

      /* Tabs: pill style */
      #productTabs { gap: 8px; }
      .nav-tabs { border: 0; margin-bottom: 12px; }
      .nav-tabs .nav-link { border-radius: 999px; border: 1px solid rgba(13,70,76,.12); background: #fff; color: #0d464c; font-weight: 700; padding: 10px 14px; }
      .nav-tabs .nav-link.active { color: #fff; background: #0d464c; border-color: #0d464c; box-shadow: none; }

      .section-card { background: #fff; border: 1px solid rgba(13,70,76,.08); border-radius: 12px; box-shadow: 0 4px 12px rgba(13,70,76,.06); }
      .section-title { color: #0d464c; font-weight: 800; }

      @media (max-width: 991.98px) {
        .thumb-img { width: 60px; height: 60px; }
        .product-gallery { position: static; }
      }
    </style>
  </body>
</html>
