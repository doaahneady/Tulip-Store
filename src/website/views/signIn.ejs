<!DOCTYPE html>
<html lang="en">
  <!-- sign up form -->
  <%- include('./includes/head') %>
  <body>
    <style>
      @import url(https://db.onlinewebfonts.com/c/ba155473d72fb574bd945b20f4598560?family=Montserrat-Alt1+SemBd);
      @import url(https://db.onlinewebfonts.com/c/29295d2928c6bd76a76c9e789982bc85?family=Montserrat-Alt1+Med);

      @font-face {
        font-family: "Montserrat-Alt1 SemBd";
        src: url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.eot");
        src: url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.eot?#iefix")
            format("embedded-opentype"),
          url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.woff2")
            format("woff2"),
          url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.woff")
            format("woff"),
          url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.ttf")
            format("truetype"),
          url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.svg#Montserrat-Alt1 SemBd")
            format("svg");
      }

      @font-face {
        font-family: "Montserrat-Alt";
        src: url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.eot");
        src: url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.eot?#iefix")
            format("embedded-opentype"),
          url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.woff2")
            format("woff2"),
          url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.woff")
            format("woff"),
          url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.ttf")
            format("truetype"),
          url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.svg#Montserrat-Alt1 Med")
            format("svg");
      }
      body {
        /* background-image: url("images/signUp.jpg"); */
        /* background-repeat: none;
        background-size: cover; */
        background-color: #0d464c;
        font-family: "Montserrat-Alt1 SemBd";
      }
      placeholder {
        font-family: "Montserrat-Alt1";
      }
      .container {
        min-height: 600px;
        padding: 20px;
        width: 500px;
      }

      .forget-link,
      .signup-link {
        background-color: transparent;
        color: #0d464c;
        text-decoration: underline;
        font-weight: bold;
        border: none;
      }
      .signup-link:hover,
      .forget-link:hover {
        font-weight: bold;
        text-shadow: 1px 0 2px #000000;
        transition: 0.2s;
      }

      #forgetForm {
        display: none;
      }
      .card-signup {
        border-radius: 40px;
        width: 100%;
        height: auto;
        background-color: #ffffff17;
        backdrop-filter: blur(20px);
        color: #0d464c;
      }
      .signUp_form {
        display: none;
      }
      .rePass {
        display: none;
      }
      form.button-front {
        border: none;
        padding: 20px;
        gap: 30px;
      }

      h3 {
        color: #0d464c;
        font-weight: 700;
        font-size: 40px;
        text-shadow: 1px 0 2px #000000;
      }
      .message-error {
        color: red;
        display: none;
      }
      .btn {
        color: #e7c8b3;
        background-color: #0d464c;
        font-weight: bolder;
        border: none;
        font-size: 22px;
        box-shadow: 2px 0 4px #000000;
      }

      .button-sign-up {
        margin-left: 450px;
      }
      .btn:hover,
      .btn::after {
        background-color: #f05928;

        color: #e7c8b3;
        border: none;
      }

      .btn a {
        color: #0d464c;
        text-decoration: none;
        padding: 10px 90px;
      }
      .btn a:hover {
        background-color: #0d464c;
        color: #e7c8b3;
        text-decoration: none;
      }
      .form-select {
        border-radius: 10px;
        border: none;
        font-weight: 500;
        background-color: #ffffff;
        color: #0d464c;
      }
      .tolip {
        background-image: url("images/tulip.png");
        background-size: cover;
        width: 200px;
        height: 200px;
      }

      /* Register phone row */
      .phone-row {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      .country-select-wrap {
        position: relative;
        flex: none;
        width: 100%;
        max-width: 100%;
      }
      .country-select {
        height: 44px;
        padding-left: 48px; /* room for flag */
        border-radius: 12px;
        border: 1px solid #e5e9ef;
        background: #fff;
        color: #0d464c;
        font-weight: 600;
      }
      .country-select:focus { box-shadow: 0 0 0 0.2rem rgba(13,70,76,0.15); }
      .flag-badge {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 18px; /* emoji flag size */
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      }
      .phone-input-group {
        flex: none;
        width: 100%;
        height: auto;
      }
      .phone-input-group .input-group-text {
        min-width: 74px;
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;
        font-weight: 800;
        color: #0d464c;
        background: #fff;
        border: 1px solid #e5e9ef;
        border-right: 0;
      }
      .phone-input-group .form-control {
        border-top-right-radius: 12px;
        border-bottom-right-radius: 12px;
        border: 1px solid #e5e9ef;
        border-left: 0;
        height: 44px;
      }
      .phone-input-group .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(13,70,76,0.15);
        border-color: #a8c3c6;
      }
      /* Inline code prefix inside the same input */
      .phone-input-wrap { position: relative; height: 44px; }
      .code-prefix {
        position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        color: #0d464c; font-weight: 800; border-right: 1px solid #e5e9ef; padding-right: 10px; min-width: 64px; text-align: left;
      }
      .phone-with-code { padding-left: 96px; height: 44px; font-size: inherit; }
      /* Custom country picker with flag images */
      .country-picker {
        width: 100%; height: 44px; border-radius: 12px; border: 1px solid #e5e9ef; background:#fff; color:#0d464c; font-weight: inherit; font-size: inherit;
        display: flex; align-items: center; gap: 8px; padding: 0 12px; justify-content: space-between;
      }
      .country-picker img { border-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .country-dropdown {
        position: absolute; left: 0; right: 0; top: calc(100% + 6px); background:#fff; border:1px solid #e5e9ef; border-radius: 12px;
        box-shadow: 0 12px 28px rgba(0,0,0,0.12); max-height: 260px; overflow-y: auto; z-index: 10000; padding: 6px; font-size: inherit;
      }
      .country-item { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer; }
      .country-item:hover { background:#f6f8fb; }
    </style>

    <div class="container d-flex align-items-center">
      <div
        class="card-signup shadow-sm"
        style="
          border-width: 2px;
          border-style: solid;
          background-color: #ffffff80;
          backdrop-filter: blur(20px);
        "
      >
        <div class="card-body p-4">
          <div class="mx-auto d-block tolip"></div>
          <h3 class="card-title text-center mb-4" id="card-title">SIGN IN</h3>
          <form
            id="signupForm"
            class="row g-3"
            novalidate
            onsubmit="return performSignup(event)"
          >
            <!-- sign in -->
            <div class="signIn_form" id="form_signIn">
              <!-- email -->
              <div class="col-12 mb-3">
                <input
                  type="email"
                  class="form-control"
                  id="inputEmail"
                  placeholder="E-mail"
                />
                <div class="message-error" id="message_email">
                  check your name
                </div>
              </div>

              <!-- password -->
              <div class="col-12 mb-3">
                <input
                  type="password"
                  class="form-control"
                  id="inputPassword"
                  placeholder="Password"
                  value=""
                />
                <div class="message-error" id="message_pass">
                  check your password
                </div>
              </div>

              <!-- forget pass -->
              <div class="mb-3">
                <button type="button" class="forget-link" id="forgetLink">
                  forget password?
                </button>
              </div>

              <!-- submit -->
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  type="submit"
                  class="btn btn-lg w-100 btn-primary"
                  id="signIn"
                >
                  Sign In
                </button>
              </div>

              <!-- sign up -->
              <p class="text">
                Don't have an account?
                <button type="button" class="signup-link" id="signupLink">
                  Sign up here
                </button>
              </p>

              <!-- or with -->
              <!-- <p class="p line-or text-center">Or With</p> -->

              <!-- back -->
              <!-- <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button type="button" class="btn btn-lg w-100" id="back">
                  <span class="btn-text"><a class="aa" href="/">back</a></span>
                </button>
              </div> -->
            </div>
            <!-- forgot password (1/2): request code -->
            <div class="forget-Form" id="forgetEmailForm" style="display: none">
              <p>Enter your account email to receive a reset code</p>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <input
                  type="email"
                  class="form-control"
                  id="forgotEmailInput"
                  placeholder="E-mail"
                />
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  type="button"
                  class="btn btn-lg w-100"
                  id="sendResetCodeBtn"
                >
                  Send Code
                </button>
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button class="btn btn-back btn-lg w-100" id="backToLogin1">
                  Back
                </button>
              </div>
            </div>
            <!-- forgot password (2/2): verify code + set new password -->
            <div
              class="forget-Form"
              id="forgetVerifyForm"
              style="display: none"
            >
              <p>Enter the code sent to your email and new password</p>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="resetCodeInput"
                  placeholder="6-digit code"
                />
              </div>
              <div class="col-12 mb-3">
                <input
                  type="password"
                  class="form-control"
                  id="newPasswordInput"
                  placeholder="New password"
                />
              </div>
              <div class="col-12 mb-3">
                <input
                  type="password"
                  class="form-control"
                  id="newPasswordInput2"
                  placeholder="Confirm new password"
                />
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  type="button"
                  class="btn btn-lg w-100"
                  id="confirmResetBtn"
                >
                  Update Password
                </button>
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button class="btn btn-back btn-lg w-100" id="backToLogin2">
                  Back
                </button>
              </div>
            </div>

            <!-- email verification after register or if login requires verification -->
            <div class="verify_form" id="verifyForm" style="display:none">
              <p>A verification code was sent to your email. Enter it below:</p>
              <div class="col-12 mb-3">
                <input type="email" class="form-control" id="verifyEmail" placeholder="E-mail" />
              </div>
              <div class="col-12 mb-3">
                <input type="text" class="form-control" id="verifyCode" placeholder="6-digit code" />
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button type="button" class="btn btn-lg w-100" id="verifyBtn">Verify Email</button>
              </div>
              <!-- Timer row (visible during countdown) -->
              <div class="col-12 d-flex justify-content-center px-0 mb-2" id="resendTimerRow" style="display:none">
                <div class="w-100 text-center" style="color:#0d464c; font-weight:600;">
                  You can resend a new code in <span id="resendTimerText">00:30</span>
                </div>
              </div>
              <!-- Resend button (appears when timer hits 0) -->
              <div class="col-12 d-flex justify-content-center px-0 mb-3" id="resendBtnRow" style="display:none">
                <button type="button" class="btn btn-lg w-100" id="resendCodeBtn">Resend Code</button>
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button class="btn btn-back btn-lg w-100" id="backToLogin3">Back to Login</button>
              </div>
            </div>

            <!-- sign up -->
            <div class="signUp_form" id="form_signUp">
              <!-- username -->
              <div class="col-12 mb-4">
                <input
                  type="text"
                  class="form-control"
                  id="inputUsername"
                  placeholder="username"
                />
                <div class="message-error" id="message_username">
                  username is required
                </div>
              </div>
              <!-- full name -->
              <div class="col-12 mb-4">
                <input
                  type="text"
                  class="form-control"
                  id="inputname"
                  placeholder="full name"
                />
                <div class="message-error" id="message_name">
                  check your name
                </div>
              </div>

              <!-- email -->
              <div class="col-12 mb-4">
                <input
                  type="email"
                  class="form-control"
                  id="EmailAddress"
                  placeholder="E-mail"
                />
                <div class="message-error" id="message_email">
                  check your email and try again.
                </div>
              </div>

              <!-- phone number (custom picker + code inside the same input) -->
              <div class="col-12 mb-4">
                <label class="form-label" style="color:#0d464c; font-weight:700;">Phone number</label>
                <div class="phone-row">
                  <!-- Country picker with flag images -->
                  <div class="country-select-wrap">
                    <button id="countryPicker" type="button" class="country-picker">
                      <img id="countryFlagImg" alt="flag" width="24" height="18" style="visibility:hidden;" />
                      <span id="countryPickerText">Select country</span>
                      <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
                    </button>
                    <div id="countryDropdown" class="country-dropdown" style="display:none;"></div>
                  </div>
                  <!-- Code prefix shown inside the same input where user types -->
                  <div class="phone-input-group">
                    <div class="phone-input-wrap">
                      <span id="codeInInput" class="code-prefix">+___</span>
                      <input type="tel" id="inputphone" class="form-control phone-with-code" placeholder="Phone number" />
                    </div>
                  </div>
                </div>
                <div class="message-error" id="message_num1">- please select your country & phone number.</div>
                <div class="message-error" id="message_num2">- The country was selected but phone number was not written</div>
                <div class="message-error" id="message_num3">- phone number was wrong, try again.</div>
              </div>

              <!-- password -->
              <div class="col-12 mb-4">
                <input
                  type="password"
                  class="form-control"
                  id="Password"
                  placeholder="Password"
                />
                <div class="message-error" id="pass_1">
                  - The password must contain at least 8 characters
                </div>
                <div class="message-error" id="pass_2">
                  - it must contain the letters A-Z and a-z
                </div>
                <div class="message-error" id="pass_3">
                  - it must contain numbers
                </div>
              </div>
              <!--dropdown -->
              <div class="row mb-3">
                <!-- language -->
                <div class="col-md-4">
                  <select id="inputLanguage" class="form-select">
                    <option hidden value="">Lang</option>
                    <option value="en">English</option>
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                  </select>
                </div>
                <!-- gender -->
                <div class="col-md-4">
                  <select id="inputGender" class="form-select">
                    <option hidden value="">Gender</option>
                    <option value="female">female</option>
                    <option value="male">male</option>
                  </select>
                </div>
                <!-- Currency -->
                <div class="col-md-4 mb-4">
                  <select id="inputCurrency" class="form-select">
                    <option hidden value="">Currency</option>
                    <option value="usd">USD</option>
                    <option value="syp">SYP</option>
                    <option value="aed">AED</option>
                  </select>
                </div>
              </div>
              <!-- Policy -->
              <div class="form-check mb-5">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value=""
                  checked
                  id="policyChecked"
                  disabled
                />
                <label class="form-check-label" for="checkDefault">
                  I agree to the <a href="/ReturnPolicy">ReturnPolicy</a> &
                  <a href="/ReturnPolicy">Shipping Policy</a>
                </label>
              </div>

              <!-- submit sign up -->
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  type="submit"
                  class="btn btn-lg w-100"
                  id="signUpButton"
                >
                  Create Account
                </button>
              </div>
              <!-- back -->
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  class="btn btn-back btn-lg w-100"
                  onclick="history.back()"
                >
                  back
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // card title
      const card_title = document.getElementById("card-title");

      // message error
      const message_name = document.getElementById("message_name");
      const message_email = document.getElementById("message_email");
      const message_num = document.getElementById("message_num");
      const message_pass = document.getElementById("message_pass");

      // sign in form
      const signIn_form = document.getElementById("form_signIn");
      const signIn_button = document.getElementById("signIn");
      const signupLink = document.getElementById("signupLink");

      // forget pass form
      const forgetLink = document.getElementById("forgetLink");
      const receiveCode = document.getElementById("receiveCode");
      const forgetForm = document.getElementById("forgetForm");

      // re password form
      const rePass = document.getElementById("rePass");
      const confirmePass = document.getElementById("confirmePass");

      // sign up form
      const signUp_form = document.getElementById("form_signUp");
      const signUpButton = document.getElementById("signUpButton");

      // sign in input
      const emailInput = document.getElementById("inputEmail");
      const passwordInput = document.getElementById("inputPassword");
      const signInBtn = document.getElementById("signIn");

      // *****************************************************************************
      // sign in
      signInBtn.addEventListener("click", async function (event) {
        event.preventDefault();

        // remove previous state
        emailInput.classList.remove("is-valid", "is-invalid");
        passwordInput.classList.remove("is-valid", "is-invalid");

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        let hasError = false;
        // validate email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email === "" || !emailRegex.test(email)) {
          emailInput.classList.add("is-invalid");
          message_email.style.display = "block";
          hasError = true;
        } else {
          emailInput.classList.add("is-valid");
          message_email.style.display = "none";
        }

        // validate password
        if (password === "") {
          passwordInput.classList.add("is-invalid");
          message_pass.style.display = "block";
          hasError = true;
        } else {
          passwordInput.classList.add("is-valid");
          message_pass.style.display = "none";
        }

        if (hasError) return;

        // Call backend login API
        try {
          const response = await fetch("http://localhost:8000/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await response.json();
          if (data.success) {
            localStorage.setItem("token", data.token);
            localStorage.setItem("user", JSON.stringify(data.user));
            localStorage.setItem("isloggedIn", "true");
            window.location.href = "/";
          } else {
            alert(data.message || "Login failed.");
            emailInput.classList.add("is-invalid");
            passwordInput.classList.add("is-invalid");
          }
        } catch (e) {
          alert("Network error. Please try again.");
        }
      });

      // *****************************************************************************
      // forget password - two-step flow
      const forgetEmailForm = document.getElementById("forgetEmailForm");
      const forgetVerifyForm = document.getElementById("forgetVerifyForm");
      const sendResetCodeBtn = document.getElementById("sendResetCodeBtn");
      const confirmResetBtn = document.getElementById("confirmResetBtn");
      const backToLogin1 = document.getElementById("backToLogin1");
      const backToLogin2 = document.getElementById("backToLogin2");

      forgetLink.addEventListener("click", function () {
        //  title
        card_title.textContent = "forget password";
        signIn_form.style.display = "none";
        forgetEmailForm.style.display = "block";
      });

      let forgotEmail = "";
      sendResetCodeBtn.addEventListener("click", async function () {
        const email = document.getElementById("forgotEmailInput").value.trim();
        if (!email) {
          alert("Please enter your email");
          return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert("Invalid email");
          return;
        }
        try {
          const resp = await fetch(
            "http://localhost:8000/api/auth/forgot-password",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            }
          );
          const data = await resp.json();
          if (data.success) {
            forgotEmail = email;
            alert("Reset code sent to your email");
            forgetEmailForm.style.display = "none";
            forgetVerifyForm.style.display = "block";
          } else {
            alert(data.message || "Failed to send reset code");
          }
        } catch (e) {
          alert("Network error. Please try again.");
        }
      });

      confirmResetBtn.addEventListener("click", async function () {
        card_title.textContent = "request code";
        const code = document.getElementById("resetCodeInput").value.trim();
        const pass1 = document.getElementById("newPasswordInput").value.trim();
        const pass2 = document.getElementById("newPasswordInput2").value.trim();
        if (!forgotEmail) {
          alert("Please send code first");
          return;
        }
        if (!code || code.length !== 6) {
          alert("Enter a valid 6-digit code");
          return;
        }
        if (!pass1 || pass1.length < 6) {
          alert("Password must be at least 6 characters");
          return;
        }
        if (pass1 !== pass2) {
          alert("Passwords do not match");
          return;
        }
        try {
          const resp = await fetch(
            "http://localhost:8000/api/auth/reset-password",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: forgotEmail,
                verification_code: code,
                password: pass1,
                password_confirmation: pass2,
              }),
            }
          );
          const data = await resp.json();
          if (data.success) {
            alert("Password updated successfully. Please login.");
            forgetVerifyForm.style.display = "none";
            signIn_form.style.display = "block";
          } else {
            alert(data.message || "Failed to reset password");
          }
        } catch (e) {
          alert("Network error. Please try again.");
        }
      });

      backToLogin1.addEventListener("click", function (e) {
        e.preventDefault();
        forgetEmailForm.style.display = "none";
        signIn_form.style.display = "block";
      });
      backToLogin2.addEventListener("click", function (e) {
        e.preventDefault();
        forgetVerifyForm.style.display = "none";
        signIn_form.style.display = "block";
      });

      // *****************************************************************************
      // sign up form
      signupLink.addEventListener("click", function () {
        card_title.textContent = "sign up";
        signIn_form.style.display = "none";
        signUp_form.style.display = "block";
      });

      // sign up: delegate to form submit handler (performSignup)
      if (signUpButton) {
        signUpButton.addEventListener("click", function (e) {
          e.preventDefault();
          const form = document.getElementById('signupForm');
          if (form && typeof form.requestSubmit === 'function') {
            form.requestSubmit();
          } else if (form) {
            form.submit();
          }
        });
      }
    </script>
    <script>
      (function(){
        const API = '/api'; // proxied to Laravel by Express
        const signupForm = document.getElementById('signupForm');
        const formSignIn = document.getElementById('form_signIn');
        const formSignUp = document.getElementById('form_signUp');
        const verifyForm = document.getElementById('verifyForm');

        // Country dropdown data and UI (native select)
        let countries = [];
        let selectedCountry = null;
        function flagEmoji(iso2){
          if (!iso2) return 'ðŸŒ';
          return iso2.toUpperCase().replace(/./g, c => String.fromCodePoint(127397 + c.charCodeAt()));
        }
        async function ensureCountries(){
          if (countries.length) return countries;
          try {
            const resp = await fetch('/api/countries');
            const data = await resp.json();
            countries = Array.isArray(data) ? data.map(c => ({ name: c.name, iso2: c.iso2, dialCode: c.dial_code })).sort((a,b)=> a.name.localeCompare(b.name)) : [];
          } catch(_) { countries = []; }
          // Fallback if API unavailable
          if (!countries.length) {
            countries = [
              { name:'United States', iso2:'us', dialCode:'1' },
              { name:'United Arab Emirates', iso2:'ae', dialCode:'971' },
              { name:'Saudi Arabia', iso2:'sa', dialCode:'966' },
              { name:'Syria', iso2:'sy', dialCode:'963' },
              { name:'Lebanon', iso2:'lb', dialCode:'961' },
              { name:'Egypt', iso2:'eg', dialCode:'20' },
              { name:'Jordan', iso2:'jo', dialCode:'962' }
            ];
          }
          return countries;
        }
        (async function setupCountryPicker(){
          const picker = document.getElementById('countryPicker');
          const list = document.getElementById('countryDropdown');
          const flagImg = document.getElementById('countryFlagImg');
          const pickerText = document.getElementById('countryPickerText');
          const codeEl = document.getElementById('codeInInput');
          if (!picker || !list || !codeEl) return;
          await ensureCountries();
          function flagUrl(iso2){ return `https://flagcdn.com/24x18/${String(iso2||'').toLowerCase()}.png`; }
          function updatePhonePadding(){
            const code = document.getElementById('codeInInput');
            const input = document.getElementById('inputphone');
            if (!code || !input) return;
            const w = code.offsetWidth || 0;
            input.style.paddingLeft = Math.max(88, w + 22) + 'px';
          }
          // Populate dropdown
          list.innerHTML = '';
          countries.forEach(c => {
            const item = document.createElement('div');
            item.className = 'country-item';
            item.innerHTML = `<img src="${flagUrl(c.iso2)}" width="24" height="18" alt="${c.iso2}"> <span>${c.name} (+${c.dialCode})</span>`;
            item.addEventListener('click', ()=>{
              selectedCountry = c;
              if (flagImg) { flagImg.src = flagUrl(c.iso2); flagImg.style.visibility = 'visible'; }
              if (pickerText) pickerText.textContent = `${c.name} (+${c.dialCode})`;
              codeEl.textContent = '+' + c.dialCode;
              updatePhonePadding();
              list.style.display = 'none';
            });
            list.appendChild(item);
          });
          // Initial padding calc and on resize
          updatePhonePadding();
          window.addEventListener('resize', updatePhonePadding);
          // Toggle dropdown
          picker.addEventListener('click', (e)=>{
            e.preventDefault();
            list.style.display = (list.style.display === 'block') ? 'none' : 'block';
          });
          // Close when clicking outside
          document.addEventListener('click', (e)=>{
            if (!picker.contains(e.target) && !list.contains(e.target)) list.style.display = 'none';
          });
        })();

        function show(el){ if(el) el.style.display='block'; }
        function hide(el){ if(el) el.style.display='none'; }

        // nav between modes
        document.getElementById('signupLink').addEventListener('click', function(){
          hide(formSignIn); hide(verifyForm); show(formSignUp);
          document.getElementById('card-title').textContent = 'SIGN UP';
          stopResendCountdown();
        });
        document.getElementById('forgetLink').addEventListener('click', function(){
            hide(formSignIn); hide(formSignUp); show(document.getElementById('forgetEmailForm'));
            document.getElementById('card-title').textContent = 'FORGOT PASSWORD';
            stopResendCountdown();
        });
        document.getElementById('backToLogin1').addEventListener('click', function(e){ e.preventDefault(); show(formSignIn); hide(document.getElementById('forgetEmailForm')); document.getElementById('card-title').textContent = 'SIGN IN'; stopResendCountdown();});
        document.getElementById('backToLogin2').addEventListener('click', function(e){ e.preventDefault(); show(formSignIn); hide(document.getElementById('forgetVerifyForm')); document.getElementById('card-title').textContent = 'SIGN IN'; stopResendCountdown();});
        document.getElementById('backToLogin3').addEventListener('click', function(e){ e.preventDefault(); show(formSignIn); hide(verifyForm); document.getElementById('card-title').textContent = 'SIGN IN'; stopResendCountdown();});

        async function api(path, method, body){
          const headers = { 'Content-Type': 'application/json' };
          const token = localStorage.getItem('token');
          if (token) headers['Authorization'] = 'Bearer ' + token;
          let res = await fetch(API + path, { method, headers, body: body ? JSON.stringify(body) : undefined });
          let data = await res.json().catch(()=>({}));
          // Fallback: if proxy 404s, try hitting Laravel directly
          if (res.status === 404) {
            try {
              const direct = await fetch('http://localhost:8000' + API + path, { method, headers, body: body ? JSON.stringify(body) : undefined });
              const directData = await direct.json().catch(()=>({}));
              return { ok: direct.ok, status: direct.status, data: directData };
            } catch (e) {
              // ignore, return original
            }
          }
          return { ok: res.ok, status: res.status, data };
        }

        // Resend countdown logic
        let _resendInt = null;
        function startResendCountdown(){
          const row = document.getElementById('resendTimerRow');
          const txt = document.getElementById('resendTimerText');
          const btnRow = document.getElementById('resendBtnRow');
          if (_resendInt) clearInterval(_resendInt);
          let left = 30; // seconds
          if (row) row.style.display = '';
          if (btnRow) btnRow.style.display = 'none';
          function render(){
            const mm = '00';
            const ss = (left<10? '0':'') + left;
            if (txt) txt.textContent = mm+':'+ss;
          }
          render();
          _resendInt = setInterval(()=>{
            left -= 1;
            if (left <= 0){
              // ensure UI shows 00:00 before toggling
              if (txt) txt.textContent = '00:00';
              clearInterval(_resendInt); _resendInt = null;
              if (row) row.style.display = 'none';
              if (btnRow) btnRow.style.display = '';
            } else {
              render();
            }
          }, 1000);
        }
        function stopResendCountdown(){
          if (_resendInt){ clearInterval(_resendInt); _resendInt = null; }
          const row = document.getElementById('resendTimerRow');
          const btnRow = document.getElementById('resendBtnRow');
          if (row) row.style.display = 'none';
          if (btnRow) btnRow.style.display = '';
        }

        // Sign in or Sign up based on visible form
        window.performSignup = async function(e){
          e.preventDefault();
          if (formSignIn.style.display !== 'none'){
            // LOGIN
            const email = document.getElementById('inputEmail').value.trim();
            const password = document.getElementById('inputPassword').value;
            const r = await api('/auth/login','POST',{ email, password });
            if (r.ok){
              localStorage.setItem('token', r.data.token);
              localStorage.setItem('user', JSON.stringify(r.data.user));
              window.location.href = '/';
            } else if (r.data && r.data.requires_verification){
              // show verify form
              hide(formSignIn); show(verifyForm);
              document.getElementById('verifyEmail').value = email;
              startResendCountdown();
              alert('Please verify your email before logging in. We sent you a code.');
            } else {
              alert(r.data?.message || 'Login failed');
            }
          } else if (formSignUp.style.display !== 'none'){
            // REGISTER with validation
            const inputname = document.getElementById('inputname');
            const inputUsername = document.getElementById('inputUsername');
            const EmailAddress = document.getElementById('EmailAddress');
            const inputphone = document.getElementById('inputphone');
            const Password = document.getElementById('Password');
            const inputLanguage = document.getElementById('inputLanguage');
            const inputGender = document.getElementById('inputGender');
            const inputCurrency = document.getElementById('inputCurrency');

            const message_num1 = document.getElementById('message_num1');
            const message_num2 = document.getElementById('message_num2');
            const message_num3 = document.getElementById('message_num3');
            const pass_1 = document.getElementById('pass_1');
            const pass_2 = document.getElementById('pass_2');
            const pass_3 = document.getElementById('pass_3');

            let hasError = false;

            // Username
            inputUsername.classList.remove('is-valid','is-invalid');
            const username = inputUsername.value.trim();
            if(!username){ inputUsername.classList.add('is-invalid'); hasError = true; } else { inputUsername.classList.add('is-valid'); }

            // Full name
            inputname.classList.remove('is-valid','is-invalid');
            const full = inputname.value.trim();
            if(!full){ inputname.classList.add('is-invalid'); hasError = true; } else { inputname.classList.add('is-valid'); }

            // Email
            EmailAddress.classList.remove('is-valid','is-invalid');
            const email = EmailAddress.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if(!emailRegex.test(email)){ EmailAddress.classList.add('is-invalid'); hasError = true; } else { EmailAddress.classList.add('is-valid'); }

            // Phone (custom validation)
            inputphone.classList.remove('is-valid','is-invalid');
            const phone = (inputphone.value || '').replace(/\D/g,'');
            const hasCountry = !!selectedCountry && !!selectedCountry.dialCode;
            message_num1.style.display = 'none';
            message_num2.style.display = 'none';
            message_num3.style.display = 'none';
            if(!hasCountry && phone === ''){
              message_num1.style.display = 'block';
              inputphone.classList.add('is-invalid');
              hasError = true;
            } else if (hasCountry && !phone) {
              message_num2.style.display = 'block';
              inputphone.classList.add('is-invalid');
              hasError = true;
            } else if (phone && (phone.length < 6 || phone.length > 15)){
              message_num3.style.display = 'block';
              inputphone.classList.add('is-invalid');
              hasError = true;
            } else {
              if (phone) inputphone.classList.add('is-valid');
            }

            // Password
            Password.classList.remove('is-valid','is-invalid');
            pass_1.style.display = 'none'; pass_2.style.display='none'; pass_3.style.display='none';
            const pass = Password.value;
            if (pass.length <= 8 || !/[A-Z]/.test(pass) || !/[0-9]/.test(pass)){
              if (pass.length <= 8) { pass_1.style.display='block'; }
              if (!/[A-Z]/.test(pass)) { pass_2.style.display='block'; }
              if (!/[0-9]/.test(pass)) { pass_3.style.display='block'; }
              Password.classList.add('is-invalid');
              hasError = true;
            } else {
              Password.classList.add('is-valid');
            }

            // Language/Gender/Currency
            inputLanguage.classList.remove('is-valid','is-invalid');
            inputGender.classList.remove('is-valid','is-invalid');
            inputCurrency.classList.remove('is-valid','is-invalid');
            const langSel = inputLanguage.value;
            const gender = inputGender.value || null;
            const currency = inputCurrency.value || null;
            if(!langSel){ inputLanguage.classList.add('is-invalid'); hasError = true; } else { inputLanguage.classList.add('is-valid'); }
            if(!gender){ inputGender.classList.add('is-invalid'); hasError = true; } else { inputGender.classList.add('is-valid'); }
            if(!currency){ inputCurrency.classList.add('is-invalid'); hasError = true; } else { inputCurrency.classList.add('is-valid'); }

            if (hasError) { return false; }

            const language = (langSel === 'ar') ? 'arabic' : 'english';
            const mobile = (phone && hasCountry) ? ('+' + selectedCountry.dialCode + phone) : null;

            const r = await api('/auth/register','POST',{
              username, email, password: pass, user_full_name: full, mobile, language, gender
            });
            if (r.ok){
              hide(formSignUp); show(verifyForm);
              document.getElementById('verifyEmail').value = email;
              document.getElementById('card-title').textContent = 'VERIFY EMAIL';
              startResendCountdown();
              alert('Registration successful. Please check your email for the code.');
            } else {
              const msg = r.data?.message || 'Registration failed';
              const errs = r.data?.errors ? ('\n' + JSON.stringify(r.data.errors)) : '';
              alert(msg + errs);
            }
          }
          return false;
        }

        // Phone input handled by custom dropdown; no extra enable/disable needed

        // Verify email
        document.getElementById('verifyBtn').addEventListener('click', async function(){
          const email = document.getElementById('verifyEmail').value.trim();
          const verification_code = document.getElementById('verifyCode').value.trim();
          const r = await api('/auth/verify-email','POST',{ email, verification_code });
          if (r.ok){
            alert('Email verified. You can now sign in.');
            show(formSignIn); hide(verifyForm);
            document.getElementById('card-title').textContent = 'SIGN IN';
            // prefill login email
            document.getElementById('inputEmail').value = email;
          } else {
            alert(r.data?.message || 'Verification failed');
          }
        });

        // Resend verification code
        document.getElementById('resendCodeBtn').addEventListener('click', async function(){
          const btn = this;
          btn.disabled = true;
          const email = document.getElementById('verifyEmail').value.trim();
          const r = await api('/auth/resend-verification','POST',{ email });
          if (r.ok){ 
            alert('Verification code resent.'); 
            // Hide button and restart countdown
            const btnRow = document.getElementById('resendBtnRow');
            const row = document.getElementById('resendTimerRow');
            if (btnRow) btnRow.style.display = 'none';
            if (row) row.style.display = '';
            startResendCountdown();
          } else { 
            alert(r.data?.message || 'Could not resend'); 
            // Keep the button visible to allow retry
          }
          btn.disabled = false;
        });

        // Forgot password flow
        document.getElementById('sendResetCodeBtn').addEventListener('click', async function(){
          const email = document.getElementById('forgotEmailInput').value.trim();
          const r = await api('/auth/forgot-password','POST',{ email });
          if (r.ok){
            hide(document.getElementById('forgetEmailForm')); show(document.getElementById('forgetVerifyForm'));
          } else {
            alert(r.data?.message || 'Could not send reset code');
          }
        });
        document.getElementById('confirmResetBtn').addEventListener('click', async function(){
          const email = document.getElementById('forgotEmailInput').value.trim();
          const verification_code = document.getElementById('resetCodeInput').value.trim();
          const password = document.getElementById('newPasswordInput').value;
          const password_confirmation = document.getElementById('newPasswordInput2').value;
          const r = await api('/auth/reset-password','POST',{ email, verification_code, password, password_confirmation });
          if (r.ok){
            alert('Password updated. Please sign in.');
            show(formSignIn); hide(document.getElementById('forgetVerifyForm'));
            document.getElementById('card-title').textContent = 'SIGN IN';
            document.getElementById('inputEmail').value = email;
          } else {
            alert(r.data?.message || 'Could not reset password');
          }
        });

        // Initial state
        show(formSignIn); hide(formSignUp); hide(verifyForm);
      })();
    </script>
  </body>
</html>
