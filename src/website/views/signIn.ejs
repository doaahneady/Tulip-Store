<!DOCTYPE html>
<html lang="en">
  <!-- sign up form -->
  <%- include('./includes/head') %>
  <body>
    <style>
      @import url(https://db.onlinewebfonts.com/c/ba155473d72fb574bd945b20f4598560?family=Montserrat-Alt1+SemBd);
      @import url(https://db.onlinewebfonts.com/c/29295d2928c6bd76a76c9e789982bc85?family=Montserrat-Alt1+Med);

      @font-face {
        font-family: "Montserrat-Alt1 SemBd";
        src: url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.eot");
        src: url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.eot?#iefix")
            format("embedded-opentype"),
          url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.woff2")
            format("woff2"),
          url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.woff")
            format("woff"),
          url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.ttf")
            format("truetype"),
          url("https://db.onlinewebfonts.com/t/ba155473d72fb574bd945b20f4598560.svg#Montserrat-Alt1 SemBd")
            format("svg");
      }

      @font-face {
        font-family: "Montserrat-Alt";
        src: url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.eot");
        src: url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.eot?#iefix")
            format("embedded-opentype"),
          url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.woff2")
            format("woff2"),
          url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.woff")
            format("woff"),
          url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.ttf")
            format("truetype"),
          url("https://db.onlinewebfonts.com/t/29295d2928c6bd76a76c9e789982bc85.svg#Montserrat-Alt1 Med")
            format("svg");
      }
      body {
        /* background-image: url("images/signUp.jpg"); */
        /* background-repeat: none;
        background-size: cover; */

        font-family: "Montserrat-Alt1 SemBd";
      }
      placeholder {
        font-family: "Montserrat-Alt1";
      }
      .container {
        min-height: 600px;
        padding: 20px;
        width: 500px;
      }

      .forget-link,
      .signup-link {
        background-color: transparent;
        color: #0d464c;
        text-decoration: underline;
        font-weight: bold;
        border: none;
      }
      .signup-link:hover,
      .forget-link:hover {
        font-weight: bold;
        text-shadow: 1px 0 2px #000000;
        transition: 0.2s;
      }

      #forgetForm {
        display: none;
      }
      .card-signup {
        border-radius: 40px;
        width: 100%;
        height: auto;
        background-color: #ffffff17;
        backdrop-filter: blur(20px);
        color: #0d464c;
      }
      .signUp_form {
        display: none;
      }
      .rePass {
        display: none;
      }
      form.button-front {
        border: none;
        padding: 20px;
        gap: 30px;
      }

      h3 {
        color: #0d464c;
        font-weight: 700;
        font-size: 40px;
        text-shadow: 1px 0 2px #000000;
      }
      .message-error {
        color: red;
        display: none;
      }
      .btn {
        color: #e7c8b3;
        background-color: #0d464c;
        font-weight: bolder;
        border: none;
        font-size: 22px;
        box-shadow: 2px 0 4px #000000;
      }

      .button-sign-up {
        margin-left: 450px;
      }
      .btn:hover,
      .btn::after {
        background-color: #f05928;

        color: #e7c8b3;
        border: none;
      }

      .btn a {
        color: #0d464c;
        text-decoration: none;
        padding: 10px 90px;
      }
      .btn a:hover {
        background-color: #0d464c;
        color: #e7c8b3;
        text-decoration: none;
      }
      .form-select {
        border-radius: 10px;
        border: none;
        font-weight: 500;
        background-color: #ffffff;
        color: #0d464c;
      }
      .tolip {
        background-image: url("images/tulip.png");
        background-size: cover;
        width: 200px;
        height: 200px;
      }
    </style>

    <div class="container d-flex align-items-center">
      <div
        class="card-signup shadow-sm"
        style="
          border-width: 2px;
          border-style: solid;
          background-color: #ffffff80;
          backdrop-filter: blur(20px);
        "
      >
        <div class="card-body p-4">
          <div class="mx-auto d-block tolip"></div>
          <h3 class="card-title text-center mb-4" id="card-title">SIGN IN</h3>
          <form
            id="signupForm"
            class="row g-3"
            novalidate
            onsubmit="return performSignup(event)"
          >
            <!-- sign in -->
            <div class="signIn_form" id="form_signIn">
              <!-- email -->
              <div class="col-12 mb-3">
                <input
                  type="email"
                  class="form-control"
                  id="inputEmail"
                  placeholder="E-mail"
                />
                <div class="message-error" id="message_email">
                  check your name
                </div>
              </div>

              <!-- password -->
              <div class="col-12 mb-3">
                <input
                  type="password"
                  class="form-control"
                  id="inputPassword"
                  placeholder="Password"
                  value=""
                />
                <div class="message-error" id="message_pass">
                  check your password
                </div>
              </div>

              <!-- forget pass -->
              <div class="mb-3">
                <button type="button" class="forget-link" id="forgetLink">
                  forget password?
                </button>
              </div>

              <!-- submit -->
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  type="submit"
                  class="btn btn-lg w-100 btn-primary"
                  id="signIn"
                >
                  Sign In
                </button>
              </div>

              <!-- sign up -->
              <p class="text">
                Don't have an account?
                <button type="button" class="signup-link" id="signupLink">
                  Sign up here
                </button>
              </p>

              <!-- or with -->
              <!-- <p class="p line-or text-center">Or With</p> -->

              <!-- back -->
              <!-- <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button type="button" class="btn btn-lg w-100" id="back">
                  <span class="btn-text"><a class="aa" href="/">back</a></span>
                </button>
              </div> -->
            </div>
            <!-- forgot password (1/2): request code -->
            <div class="forget-Form" id="forgetEmailForm" style="display: none">
              <p>Enter your account email to receive a reset code</p>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <input
                  type="email"
                  class="form-control"
                  id="forgotEmailInput"
                  placeholder="E-mail"
                />
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  type="button"
                  class="btn btn-lg w-100"
                  id="sendResetCodeBtn"
                >
                  Send Code
                </button>
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button class="btn btn-back btn-lg w-100" id="backToLogin1">
                  Back
                </button>
              </div>
            </div>
            <!-- forgot password (2/2): verify code + set new password -->
            <div
              class="forget-Form"
              id="forgetVerifyForm"
              style="display: none"
            >
              <p>Enter the code sent to your email and new password</p>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="resetCodeInput"
                  placeholder="6-digit code"
                />
              </div>
              <div class="col-12 mb-3">
                <input
                  type="password"
                  class="form-control"
                  id="newPasswordInput"
                  placeholder="New password"
                />
              </div>
              <div class="col-12 mb-3">
                <input
                  type="password"
                  class="form-control"
                  id="newPasswordInput2"
                  placeholder="Confirm new password"
                />
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  type="button"
                  class="btn btn-lg w-100"
                  id="confirmResetBtn"
                >
                  Update Password
                </button>
              </div>
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button class="btn btn-back btn-lg w-100" id="backToLogin2">
                  Back
                </button>
              </div>
            </div>
            <!-- sign up -->
            <div class="signUp_form" id="form_signUp">
              <!-- full name -->
              <div class="col-12 mb-4">
                <input
                  type="text"
                  class="form-control"
                  id="inputname"
                  placeholder="full name"
                />
                <div class="message-error" id="message_name">
                  check your name
                </div>
              </div>

              <!-- email -->
              <div class="col-12 mb-4">
                <input
                  type="email"
                  class="form-control"
                  id="EmailAddress"
                  placeholder="E-mail"
                />
                <div class="message-error" id="message_email">
                  check your email and try again.
                </div>
              </div>

              <!-- phone number -->
              <div class="col-12 mb-4">
                <div class="d-flex">
                  <select
                    id="flag"
                    class="form-select"
                    style="width: 130px; border-radius: 5px 0 0 5px"
                  >
                    <option hidden selected value="">Select</option>
                    <option value="+963">ðŸ‡¸ðŸ‡¾ +963</option>
                    <option value="+961">ðŸ‡±ðŸ‡§ +961</option>
                    <option value="+20">ðŸ‡ªðŸ‡¬ +20</option>
                    <option value="+966">ðŸ‡¸ðŸ‡¦ +966</option>
                    <option value="+962">ðŸ‡¯ðŸ‡´ +962</option>
                  </select>

                  <input
                    type="text"
                    id="inputphone"
                    class="form-control"
                    placeholder="Phone number"
                    style="border-radius: 0 5px 5px 0"
                    disabled
                  />
                </div>
                <div class="message-error" id="message_num1">
                  - please select your country & phone number.
                </div>
                <div class="message-error" id="message_num2">
                  - The key was selected(country) but phone number was not
                  written
                </div>
                <div class="message-error" id="message_num3">
                  - phone number was wrong try again.
                </div>
              </div>

              <!-- password -->
              <div class="col-12 mb-4">
                <input
                  type="password"
                  class="form-control"
                  id="Password"
                  placeholder="Password"
                />
                <div class="message-error" id="pass_1">
                  - The password must contain at least 8 characters
                </div>
                <div class="message-error" id="pass_2">
                  - it must contain the letters A-Z and a-z
                </div>
                <div class="message-error" id="pass_3">
                  - it must contain numbers
                </div>
              </div>
              <!--dropdown -->
              <div class="row mb-3">
                <!-- language -->
                <div class="col-md-4">
                  <select id="inputLanguage" class="form-select">
                    <option hidden value="">Lang</option>
                    <option value="en">English</option>
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                  </select>
                </div>
                <!-- gender -->
                <div class="col-md-4">
                  <select id="inputGender" class="form-select">
                    <option hidden value="">Gender</option>
                    <option value="female">female</option>
                    <option value="male">male</option>
                  </select>
                </div>
                <!-- Currency -->
                <div class="col-md-4 mb-4">
                  <select id="inputCurrency" class="form-select">
                    <option hidden value="">Currency</option>
                    <option value="usd">USD</option>
                    <option value="syp">SYP</option>
                    <option value="aed">AED</option>
                  </select>
                </div>
              </div>
              <!-- Policy -->
              <div class="form-check mb-5">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value=""
                  checked
                  id="policyChecked"
                  disabled
                />
                <label class="form-check-label" for="checkDefault">
                  I agree to the <a href="/ReturnPolicy">ReturnPolicy</a> &
                  <a href="/ReturnPolicy">Shipping Policy</a>
                </label>
              </div>

              <!-- submit sign up -->
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  type="button"
                  class="btn btn-lg w-100"
                  id="signUpButton"
                >
                  Creat Account
                </button>
              </div>
              <!-- back -->
              <div class="col-12 d-flex justify-content-center px-0 mb-3">
                <button
                  class="btn btn-back btn-lg w-100"
                  onclick="history.back()"
                >
                  back
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // card title
      const card_title = document.getElementById("card-title");

      // message error
      const message_name = document.getElementById("message_name");
      const message_email = document.getElementById("message_email");
      const message_num = document.getElementById("message_num");
      const message_pass = document.getElementById("message_pass");

      // sign in form
      const signIn_form = document.getElementById("form_signIn");
      const signIn_button = document.getElementById("signIn");
      const signupLink = document.getElementById("signupLink");

      // forget pass form
      const forgetLink = document.getElementById("forgetLink");
      const receiveCode = document.getElementById("receiveCode");
      const forgetForm = document.getElementById("forgetForm");

      // re password form
      const rePass = document.getElementById("rePass");
      const confirmePass = document.getElementById("confirmePass");

      // sign up form
      const signUp_form = document.getElementById("form_signUp");
      const signUpButton = document.getElementById("signUpButton");

      // sign in input
      const emailInput = document.getElementById("inputEmail");
      const passwordInput = document.getElementById("inputPassword");
      const signInBtn = document.getElementById("signIn");

      // *****************************************************************************
      // sign in
      signInBtn.addEventListener("click", async function (event) {
        event.preventDefault();

        // remove previous state
        emailInput.classList.remove("is-valid", "is-invalid");
        passwordInput.classList.remove("is-valid", "is-invalid");

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        let hasError = false;
        // validate email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email === "" || !emailRegex.test(email)) {
          emailInput.classList.add("is-invalid");
          message_email.style.display = "block";
          hasError = true;
        } else {
          emailInput.classList.add("is-valid");
          message_email.style.display = "none";
        }

        // validate password
        if (password === "") {
          passwordInput.classList.add("is-invalid");
          message_pass.style.display = "block";
          hasError = true;
        } else {
          passwordInput.classList.add("is-valid");
          message_pass.style.display = "none";
        }

        if (hasError) return;

        // Call backend login API
        try {
          const response = await fetch("http://localhost:8000/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await response.json();
          if (data.success) {
            localStorage.setItem("token", data.token);
            localStorage.setItem("user", JSON.stringify(data.user));
            localStorage.setItem("isloggedIn", "true");
            window.location.href = "/";
          } else {
            alert(data.message || "Login failed.");
            emailInput.classList.add("is-invalid");
            passwordInput.classList.add("is-invalid");
          }
        } catch (e) {
          alert("Network error. Please try again.");
        }
      });

      // *****************************************************************************
      // forget password - two-step flow
      const forgetEmailForm = document.getElementById("forgetEmailForm");
      const forgetVerifyForm = document.getElementById("forgetVerifyForm");
      const sendResetCodeBtn = document.getElementById("sendResetCodeBtn");
      const confirmResetBtn = document.getElementById("confirmResetBtn");
      const backToLogin1 = document.getElementById("backToLogin1");
      const backToLogin2 = document.getElementById("backToLogin2");

      forgetLink.addEventListener("click", function () {
        //  title
        card_title.textContent = "forget password";
        signIn_form.style.display = "none";
        forgetEmailForm.style.display = "inline";
      });

      let forgotEmail = "";
      sendResetCodeBtn.addEventListener("click", async function () {
        const email = document.getElementById("forgotEmailInput").value.trim();
        if (!email) {
          alert("Please enter your email");
          return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert("Invalid email");
          return;
        }
        try {
          const resp = await fetch(
            "http://localhost:8000/api/auth/forgot-password",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            }
          );
          const data = await resp.json();
          if (data.success) {
            forgotEmail = email;
            alert("Reset code sent to your email");
            forgetEmailForm.style.display = "none";
            forgetVerifyForm.style.display = "inline";
          } else {
            alert(data.message || "Failed to send reset code");
          }
        } catch (e) {
          alert("Network error. Please try again.");
        }
      });

      confirmResetBtn.addEventListener("click", async function () {
        card_title.textContent = "request code";
        const code = document.getElementById("resetCodeInput").value.trim();
        const pass1 = document.getElementById("newPasswordInput").value.trim();
        const pass2 = document.getElementById("newPasswordInput2").value.trim();
        if (!forgotEmail) {
          alert("Please send code first");
          return;
        }
        if (!code || code.length !== 6) {
          alert("Enter a valid 6-digit code");
          return;
        }
        if (!pass1 || pass1.length < 6) {
          alert("Password must be at least 6 characters");
          return;
        }
        if (pass1 !== pass2) {
          alert("Passwords do not match");
          return;
        }
        try {
          const resp = await fetch(
            "http://localhost:8000/api/auth/reset-password",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: forgotEmail,
                verification_code: code,
                password: pass1,
                password_confirmation: pass2,
              }),
            }
          );
          const data = await resp.json();
          if (data.success) {
            alert("Password updated successfully. Please login.");
            forgetVerifyForm.style.display = "none";
            signIn_form.style.display = "inline";
          } else {
            alert(data.message || "Failed to reset password");
          }
        } catch (e) {
          alert("Network error. Please try again.");
        }
      });

      backToLogin1.addEventListener("click", function (e) {
        e.preventDefault();
        forgetEmailForm.style.display = "none";
        signIn_form.style.display = "inline";
      });
      backToLogin2.addEventListener("click", function (e) {
        e.preventDefault();
        forgetVerifyForm.style.display = "none";
        signIn_form.style.display = "inline";
      });

      // *****************************************************************************
      // sign up form
      signupLink.addEventListener("click", function () {
        card_title.textContent = "sign up";
        signIn_form.style.display = "none";
        signUp_form.style.display = "inline";
      });

      // sign up validation
      signUpButton.addEventListener("click", async function () {
        const inputname = document.getElementById("inputname");
        const EmailAddress = document.getElementById("EmailAddress");
        const inputphone = document.getElementById("inputphone");
        const Password = document.getElementById("Password");
        const inputLanguage = document.getElementById("inputLanguage");
        const inputGender = document.getElementById("inputGender");
        const inputCurrency = document.getElementById("inputCurrency");
        const policyChecked = document.getElementById("policyChecked");
        const flag = document.getElementById("flag");

        const message_num1 = document.getElementById("message_num1");
        const message_num2 = document.getElementById("message_num2");
        const message_num3 = document.getElementById("message_num3");

        const pass_1 = document.getElementById("pass_1");
        const pass_2 = document.getElementById("pass_2");
        const pass_3 = document.getElementById("pass_3");
        let SignError = false;
        // validate full name
        inputname.classList.remove("is-valid", "is-invalid");
        const name = inputname.value;
        if (name === "") {
          inputname.classList.add("is-invalid");
          SignError = true;
        } else {
          inputname.classList.add("is-valid");
        }

        // validate email
        EmailAddress.classList.remove("is-valid", "is-invalid");
        const emailAddress = EmailAddress.value;
        if (/^[\w.-]+@gmail\.com$/.test(emailAddress)) {
          EmailAddress.classList.add("is-valid");
        } else {
          EmailAddress.classList.add("is-invalid");
          SignError = true;
        }

        //  phone number
        flag.addEventListener("change", validatePhone);

        function validatePhone() {
          const countryCode = flag.value.trim();
          const phone = inputphone.value.trim();

          flag.classList.remove("is-valid", "is-invalid");
          inputphone.classList.remove("is-valid", "is-invalid");

          if (countryCode === "" && phone === "") {
            message_num1.style.display = "block";
            flag.classList.add("is-invalid");
            inputphone.classList.add("is-invalid");
            SignError = true;
            return;
          }

          if (countryCode !== "") {
            if (!phone.startsWith(countryCode)) {
              inputphone.disabled = false;
              inputphone.value = countryCode + " ";
            }
            flag.classList.add("is-valid");
            message_num1.style.display = "none";
            message_num2.style.display = "block";
          }

          const regex = /^[+0-9\s]+$/;
          if (!regex.test(phone) && !inputphone.disabled) {
            alert("test");
            message_num3.style.display = "block";
            inputphone.classList.add("is-invalid");
            SignError = true;
            return;
          }

          if (countryCode !== "" && phone.startsWith(countryCode)) {
            flag.classList.add("is-valid");
            inputphone.classList.add("is-valid");
            message_num1.style.display = "none";
            message_num2.style.display = "none";
            message_num3.style.display = "none";
          }
        }
        // validate phone
        validatePhone();

        // validate password
        Password.classList.remove("is-valid", "is-invalid");
        const pass = Password.value;
        if (pass.length <= 8 || !/[A-Z]/.test(pass) || !/[0-9]/.test(pass)) {
          if (pass.length <= 8) {
            Password.classList.add("is-invalid");
            pass_1.style.display = "block";
            SignError = true;
          } else {
            pass_1.style.display = "none";
          }
          if (!/[A-Z]/.test(pass)) {
            pass_2.style.display = "block";
          } else {
            pass_2.style.display = "none";
          }
          if (!/[0-9]/.test(pass)) {
            pass_3.style.display = "block";
          } else {
            pass_3.style.display = "none";
          }
        } else {
          Password.classList.add("is-valid");
          pass_1.style.display = "none";
          pass_2.style.display = "none";
          pass_3.style.display = "none";
        }

        // validate language
        inputLanguage.classList.remove("is-valid", "is-invalid");
        const lang = inputLanguage.value;
        if (lang === "") {
          inputLanguage.classList.add("is-invalid");
          SignError = true;
        } else {
          inputLanguage.classList.add("is-valid");
        }

        // validate gender
        inputGender.classList.remove("is-valid", "is-invalid");
        const Gender = inputGender.value;
        if (Gender === "") {
          inputGender.classList.add("is-invalid");
          SignError = true;
        } else {
          inputGender.classList.add("is-valid");
        }

        // validate currency
        inputCurrency.classList.remove("is-valid", "is-invalid");
        const Currency = inputCurrency.value;
        if (Currency === "") {
          inputCurrency.classList.add("is-invalid");
          SignError = true;
        } else {
          inputCurrency.classList.add("is-valid");
        }

        if (SignError) {
          return;
        } else {
          alert("Welcome");
          window.location.href = "/";
        }
      });
    </script>
  </body>
</html>
